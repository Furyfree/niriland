#!/usr/bin/env bash

set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INSTALL_DIR="$ROOT_DIR/scripts/install"
STEPS_DIR="$INSTALL_DIR/steps"
source "$INSTALL_DIR/lib/common"
source "$INSTALL_DIR/lib/options"

read_system_pass
read_luks_pass
read_git_config
setup_git_user

INSTALL_GAMING=false
if should_install_gaming; then
  INSTALL_GAMING=true
fi

INSTALL_AI=false
if should_install_ai; then
  INSTALL_AI=true
fi

STEPS=(
  "$STEPS_DIR/00-setup-pacman"
  "$STEPS_DIR/05-setup-fde"
  "$STEPS_DIR/10-install-drivers"
  "$STEPS_DIR/15-install-packages"
  "$STEPS_DIR/17-setup-dms"
  "$STEPS_DIR/20-deploy-configs"
  "$STEPS_DIR/25-setup-theming"
  "$STEPS_DIR/30-setup-shell"
  "$STEPS_DIR/32-setup-keyring"
  "$STEPS_DIR/35-setup-tools"
)

if "$INSTALL_GAMING"; then
  STEPS+=("$STEPS_DIR/40-setup-gaming")
else
  log "Skipping gaming apps setup."
fi

STEPS+=(
  "$STEPS_DIR/45-setup-dev"
  "$STEPS_DIR/50-setup-browser"
  "$STEPS_DIR/60-setup-certificates"
)

if "$INSTALL_AI"; then
  STEPS+=("$STEPS_DIR/65-setup-ai")
else
  log "Skipping AI setup."
fi

STEPS+=(
  "$STEPS_DIR/70-setup-desktop-entries"
  "$STEPS_DIR/85-optimize-system"
  "$STEPS_DIR/99-post-install"
)

for step in "${STEPS[@]}"; do
  if [[ ! -x "$step" ]]; then
    die "Step not found or not executable: $step"
  fi

  log "Running $(basename "$step")"
  bash "$step"
done

cleanup_all

log "Done"
