#!/usr/bin/env bash

LIB_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$LIB_DIR/../../.." && pwd)"

log() {
  printf '==> %s\n' "$*"
}

die() {
  printf 'ERROR: %s\n' "$*" >&2
  exit 1
}

require_sudo() {
  sudo -v || die "sudo authentication failed"
}

require_paru() {
  if ! command -v paru >/dev/null 2>&1; then
    die "paru is required but not installed. Run 00-setup-pacman first."
  fi
}

install_package() {
  local pkg="$1"

  if pacman -Qq "$pkg" >/dev/null 2>&1; then
    log "$pkg already installed, skipping."
    return 0
  fi

  log "Installing $pkg..."
  sudo pacman -S --needed --noconfirm "$pkg" || die "Failed to install $pkg"
}

install_aur_package() {
  local pkg="$1"
  if pacman -Qq "$pkg" >/dev/null 2>&1; then
    log "$pkg already installed, skipping."
    return 0
  fi
  log "Installing $pkg..."
  paru -S --needed --noconfirm "$pkg" || die "Failed to install $pkg"
}

copy_file() {
  local src="$1"
  local dest="$2"
  local backup="${3:-true}"

  [[ -f "$src" ]] || die "File not found: $src"

  if [[ "$backup" == "true" ]] && [[ -f "$dest" ]] && ! cmp -s "$src" "$dest"; then
    local backup_path="${dest}.bak.$(date +%s)"
    log "Backing up $dest to $backup_path..."
    sudo cp "$dest" "$backup_path" || die "Failed to backup $dest"
  fi

  log "Copying $src to $dest..."
  sudo cp "$src" "$dest" || die "Failed to copy $src to $dest"
}
