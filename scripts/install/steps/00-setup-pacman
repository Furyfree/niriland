#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/common"

require_sudo

# Deploy our pacman.conf (Color, ILoveCandy, ParallelDownloads, multilib, etc.)
copy_file "$REPO_ROOT/configs/base/etc/pacman.conf" "/etc/pacman.conf"

# --- Chaotic AUR ---
if ! grep -q '^\[chaotic-aur\]' /etc/pacman.conf; then
    log "Setting up Chaotic AUR..."
    sudo pacman-key --recv-key 3056513887B78AEB --keyserver keyserver.ubuntu.com
    sudo pacman-key --lsign-key 3056513887B78AEB
    sudo pacman -U --noconfirm --needed \
        'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst' \
        'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst'

    printf '\n[chaotic-aur]\nInclude = /etc/pacman.d/chaotic-mirrorlist\n' \
        | sudo tee -a /etc/pacman.conf >/dev/null

    sudo pacman -Sy --noconfirm
    log "Chaotic AUR added."
else
    log "Chaotic AUR already configured, skipping."
fi

# --- Paru ---
install_package paru

# --- Paru config ---
log "Configuring paru..."
sudo sed -i \
    -e 's/^#BottomUp/BottomUp/' \
    -e 's/^#SudoLoop/SudoLoop/' \
    -e 's/^#CombinedUpgrade/CombinedUpgrade/' \
    -e 's/^#UpgradeMenu/UpgradeMenu/' \
    -e 's/^#NewsOnUpgrade/NewsOnUpgrade/' /etc/paru.conf

if ! grep -q '^SkipReview' /etc/paru.conf; then
    echo 'SkipReview' | sudo tee -a /etc/paru.conf >/dev/null
fi

# --- Cleanup cache timer ---
install_package pacman-contrib
sudo systemctl enable --now paccache.timer

log "Pacman setup complete."
