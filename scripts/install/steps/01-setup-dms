#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/common"

log "Setting up DankMaterialShell via dankinstall..."

require_cmd curl

# --- Run dankinstall (interactive) ---
curl -fsSL https://install.danklinux.com | sh

# --- Greeter setup ---
TARGET_USER="${SUDO_USER:-${USER:-}}"
if [[ -z "$TARGET_USER" ]]; then
  die "Unable to determine target user for DMS greeter setup."
fi

log "Installing DMS greeter..."
require_paru
install_aur_package greetd-dms-greeter-git

log "Ensuring greeter group access for $TARGET_USER..."
run_sudo groupadd -f greeter
run_sudo usermod -aG greeter "$TARGET_USER"

if command -v dms >/dev/null 2>&1; then
  if dms greeter enable 2>/dev/null && dms greeter sync 2>/dev/null; then
    log "DMS greeter configured."
  else
    warn "DMS greeter setup failed (no active session?). Run 'dms greeter enable && dms greeter sync' after first login."
  fi
else
  warn "dms command not found after install; skipping greeter setup."
fi

log_success "DMS setup complete."
