#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/common"

require_sudo

log "Setting up FDE auto-unlock with TPM2..."

# Trap to clear password
trap 'unset PASSPHRASE' EXIT

# --- TPM presence check (skip if unavailable) ---
if [ ! -e /dev/tpmrm0 ] && [ ! -e /dev/tpm0 ]; then
  log "No TPM device found, skipping FDE auto-unlock setup."
  exit 0
fi

# Check prerequisites
require_paru

# Install required packages
for pkg in limine-mkinitcpio-hook limine-snapper-sync; do
  if ! pacman -Qi "$pkg" &>/dev/null; then
    log "Installing $pkg..."
    paru -S --noconfirm --needed "$pkg"
  fi
done

# --- Determine root mapper ---
ROOT_SRC="$(findmnt -n -o SOURCE /)"
MAPPER_NAME="$(echo "$ROOT_SRC" | sed 's|^/dev/mapper/||; s|\[.*||')"

if [ -z "$MAPPER_NAME" ]; then
  die "Could not determine root mapper"
fi

if ! sudo cryptsetup status "$MAPPER_NAME" >/dev/null 2>&1; then
  die "Root is not a LUKS mapper"
fi

log "Root mapper: $MAPPER_NAME"

# --- Resolve underlying LUKS device (authoritative) ---
LUKS_DEV="$(sudo cryptsetup status "$MAPPER_NAME" | awk '/device:/ {print $2}')"

if [ -z "$LUKS_DEV" ]; then
  die "Could not resolve LUKS device for root"
fi

log "Underlying LUKS device: $LUKS_DEV"

# --- Verify LUKS2 ---
if ! sudo cryptsetup luksDump "$LUKS_DEV" | head -n 5 | grep -q "Version:[[:space:]]*2"; then
  die "$LUKS_DEV is not LUKS2"
fi

# --- Get LUKS UUID ---
LUKS_UUID="$(sudo cryptsetup luksUUID "$LUKS_DEV")"

if [ -z "$LUKS_UUID" ]; then
  die "Failed to get LUKS UUID"
fi

log "LUKS UUID: $LUKS_UUID"

# --- Get passphrase (cached from get_password) ---
read_passphrase() {
  # Use cached password from get_password if available
  if [ -n "${_PASSWORD:-}" ]; then
    printf '%s' "$_PASSWORD"
    return 0
  fi

  # Prefer a direct TTY prompt when available (even if stdin isn't a tty)
  if [ -r /dev/tty ]; then
    local passphrase=""
    read -r -s -p "Enter current LUKS passphrase for $LUKS_DEV: " passphrase </dev/tty
    printf '\n' >/dev/tty
    printf '%s' "$passphrase"
    return 0
  fi

  # Fall back to systemd-ask-password (start agent if needed)
  if command -v systemd-tty-ask-password-agent >/dev/null 2>&1; then
    sudo systemd-tty-ask-password-agent --watch >/tmp/systemd-ask-pass.log 2>&1 &
  fi

  systemd-ask-password "Enter current LUKS passphrase for $LUKS_DEV:"
}

# --- Check existing tokens and prompt once (if needed) ---
HAVE_RECOVERY=false
HAVE_TPM2=false

require_sudo
if sudo cryptsetup luksDump --dump-json-metadata "$LUKS_DEV" | grep -q '"type"[[:space:]]*:[[:space:]]*"systemd-recovery"'; then
  HAVE_RECOVERY=true
  log "Recovery key already enrolled"
fi

require_sudo
if sudo cryptsetup luksDump --dump-json-metadata "$LUKS_DEV" | grep -q '"type"[[:space:]]*:[[:space:]]*"systemd-tpm2"'; then
  HAVE_TPM2=true
  log "TPM2 auto-unlock already enrolled"
fi

# Prompt once if we need to enroll either recovery or TPM2
if [ "$HAVE_RECOVERY" != "true" ] || [ "$HAVE_TPM2" != "true" ]; then
  PASSPHRASE="$(read_passphrase)"
fi

# --- Ensure crypttab.initramfs entry ---
CRYPTTAB="/etc/crypttab.initramfs"
ENTRY="$MAPPER_NAME UUID=$LUKS_UUID - tpm2-device=auto"

sudo touch "$CRYPTTAB"

if grep -q "^$MAPPER_NAME[[:space:]]" "$CRYPTTAB"; then
  if grep -q "^$ENTRY$" "$CRYPTTAB"; then
    log "crypttab entry already correct"
  else
    die "$MAPPER_NAME entry exists but differs: $(grep "^$MAPPER_NAME " "$CRYPTTAB")"
  fi
else
  log "Adding crypttab entry"
  echo "$ENTRY" | sudo tee -a "$CRYPTTAB" >/dev/null
fi

# --- Configure mkinitcpio for systemd + sd-encrypt ---
log "Configuring mkinitcpio (systemd-based initramfs)"

CONF_DIR="/etc/mkinitcpio.conf.d"
CONF_FILE="$CONF_DIR/fde-systemd.conf"

sudo mkdir -p "$CONF_DIR"
sudo touch "$CONF_FILE"

sudo tee "$CONF_FILE" >/dev/null <<'EOF'
# systemd-based initramfs for TPM2 auto-unlock
HOOKS=(base systemd autodetect microcode modconf kms keyboard sd-vconsole block sd-encrypt filesystems fsck)
EOF

log "Written $CONF_FILE"

# --- Ensure correct root= in kernel cmdline ---
CMDLINE="/etc/kernel/cmdline"
CMDLINE_DIR="$(dirname "$CMDLINE")"

sudo mkdir -p "$CMDLINE_DIR"
sudo touch "$CMDLINE"

CURRENT_CMDLINE="$(cat "$CMDLINE")"
REQUIRED_ROOT="root=/dev/mapper/$MAPPER_NAME"

if echo "$CURRENT_CMDLINE" | grep -qw "$REQUIRED_ROOT"; then
  log "Kernel cmdline already has correct root="
elif echo "$CURRENT_CMDLINE" | grep -qw "root="; then
  log "Fixing existing root= entry"
  NEW_CMDLINE="$(echo "$CURRENT_CMDLINE" | sed "s|root=[^ ]*|$REQUIRED_ROOT|")"
  echo "$NEW_CMDLINE" | sudo tee "$CMDLINE" >/dev/null
else
  log "Adding missing root= entry"
  echo "$CURRENT_CMDLINE $REQUIRED_ROOT" | sudo tee "$CMDLINE" >/dev/null
fi

# --- Create and store recovery key (idempotent) ---
RECOVERY_FILE="/root/luks-recovery-key.txt"

if [ "$HAVE_RECOVERY" != "true" ]; then
  log "Creating LUKS recovery key"
  printf '%s\n' "$PASSPHRASE" | sudo systemd-cryptenroll "$LUKS_DEV" --recovery-key --password | sudo tee "$RECOVERY_FILE" >/dev/null

  log "Recovery key saved to $RECOVERY_FILE"

  # ASSERT: recovery token now exists
  sudo cryptsetup luksDump --dump-json-metadata "$LUKS_DEV" | grep -q '"type"[[:space:]]*:[[:space:]]*"systemd-recovery"'

  sudo chmod 600 "$RECOVERY_FILE"
fi

if [ "$HAVE_TPM2" != "true" ]; then
  log "Enrolling TPM2 auto-unlock"
  printf '%s\n' "$PASSPHRASE" | sudo systemd-cryptenroll "$LUKS_DEV" --tpm2-device=auto --password
fi

# --- Final rebuild ---
log "Updating bootloader and initramfs"
sudo limine-update

log "FDE auto-unlock setup complete"
log "Recovery key is stored in $RECOVERY_FILE (keep this safe!)"
