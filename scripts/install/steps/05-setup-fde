#!/usr/bin/env bash

set -euo pipefail

cleanup() {
  if [ -n "${LUKS_PASSWORD:-}" ]; then
    unset LUKS_PASSWORD
  fi
  if [ -n "${TEMP_KEYFILE:-}" ] && [ -f "$TEMP_KEYFILE" ]; then
    if command -v shred >/dev/null 2>&1; then
      shred -u "$TEMP_KEYFILE"
    else
      rm -f "$TEMP_KEYFILE"
    fi
    unset TEMP_KEYFILE
  fi
}
trap cleanup EXIT

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/common"

require_sudo

log "Setting up FDE auto-unlock with TPM2..."

# --- TPM presence check (skip if unavailable) ---
if [ ! -e /dev/tpmrm0 ] && [ ! -e /dev/tpm0 ]; then
  log "No TPM device found, skipping FDE auto-unlock setup."
  exit 0
fi

# Check prerequisites
require_paru

# Install required packages
for pkg in limine-mkinitcpio-hook limine-snapper-sync; do
  if ! pacman -Qi "$pkg" &>/dev/null; then
    log "Installing $pkg..."
    paru -S --noconfirm --needed "$pkg"
  fi
done

# --- Determine root mapper ---
ROOT_SRC="$(findmnt -n -o SOURCE /)"
MAPPER_NAME="$(echo "$ROOT_SRC" | sed 's|^/dev/mapper/||; s|\[.*||')"

if [ -z "$MAPPER_NAME" ]; then
  die "Could not determine root mapper"
fi

if ! sudo cryptsetup status "$MAPPER_NAME" >/dev/null 2>&1; then
  die "Root is not a LUKS mapper"
fi

log "Root mapper: $MAPPER_NAME"

# --- Resolve underlying LUKS device (authoritative) ---
LUKS_DEV="$(sudo cryptsetup status "$MAPPER_NAME" | awk '/device:/ {print $2}')"

if [ -z "$LUKS_DEV" ]; then
  die "Could not resolve LUKS device for root"
fi

log "Underlying LUKS device: $LUKS_DEV"

# --- Verify LUKS2 ---
if ! sudo cryptsetup luksDump "$LUKS_DEV" | head -n 5 | grep -q "Version:[[:space:]]*2"; then
  die "$LUKS_DEV is not LUKS2"
fi

# --- Get LUKS UUID ---
LUKS_UUID="$(sudo cryptsetup luksUUID "$LUKS_DEV")"

if [ -z "$LUKS_UUID" ]; then
  die "Failed to get LUKS UUID"
fi

log "LUKS UUID: $LUKS_UUID"

# --- Check existing tokens ---
HAVE_RECOVERY=false
HAVE_TPM2=false

require_sudo
if sudo cryptsetup luksDump --dump-json-metadata "$LUKS_DEV" | grep -q '"type"[[:space:]]*:[[:space:]]*"systemd-recovery"'; then
  HAVE_RECOVERY=true
  log "Recovery key already enrolled"
fi

require_sudo
if sudo cryptsetup luksDump --dump-json-metadata "$LUKS_DEV" | grep -q '"type"[[:space:]]*:[[:space:]]*"systemd-tpm2"'; then
  HAVE_TPM2=true
  log "TPM2 auto-unlock already enrolled"
fi

# --- Configure mkinitcpio for systemd + sd-encrypt ---
log "Configuring mkinitcpio (systemd-based initramfs)"

CONF_DIR="/etc/mkinitcpio.conf.d"
CONF_FILE="$CONF_DIR/fde-systemd.conf"

sudo mkdir -p "$CONF_DIR"
sudo touch "$CONF_FILE"

sudo tee "$CONF_FILE" >/dev/null <<'EOF'
# systemd-based initramfs for TPM2 auto-unlock
HOOKS=(base systemd autodetect microcode modconf kms keyboard sd-vconsole block sd-encrypt filesystems fsck)
EOF

log "Written $CONF_FILE"

# --- Ensure correct kernel cmdline for systemd-based initramfs ---
CMDLINE="/etc/kernel/cmdline"
CMDLINE_DIR="$(dirname "$CMDLINE")"

sudo mkdir -p "$CMDLINE_DIR"
sudo touch "$CMDLINE"

REQUIRED_LUKS="rd.luks.name=$LUKS_UUID=$MAPPER_NAME"
REQUIRED_ROOT="root=/dev/mapper/$MAPPER_NAME"
CURRENT_CMDLINE="$(cat "$CMDLINE")"

# Normalize whitespace to a single line
CURRENT_CMDLINE="$(echo "$CURRENT_CMDLINE" | tr '\n' ' ' | xargs || true)"

TOKENS=()
REMOVED=false
for token in $CURRENT_CMDLINE; do
  case "$token" in
    root=*)
      REMOVED=true
      continue
      ;;
    rd.luks.name=*)
      rest="${token#rd.luks.name=}"
      token_uuid="${rest%%=*}"
      token_name="${rest#*=}"
      if [ "$token_uuid" = "$LUKS_UUID" ] || [ "$token_name" = "$MAPPER_NAME" ]; then
        REMOVED=true
        continue
      fi
      ;;
  esac
  TOKENS+=("$token")
done

UPDATED=false
ensure_token() {
  local needle="$1"
  local present=false
  local t

  for t in "${TOKENS[@]}"; do
    if [ "$t" = "$needle" ]; then
      present=true
      break
    fi
  done

  if [ "$present" != "true" ]; then
    TOKENS+=("$needle")
    UPDATED=true
  fi
}

ensure_token "$REQUIRED_LUKS"
ensure_token "$REQUIRED_ROOT"
ensure_token "rw"
ensure_token "quiet"

if [ "$UPDATED" = "true" ] || [ "$REMOVED" = "true" ]; then
  NEW_CMDLINE="$(printf '%s ' "${TOKENS[@]}" | sed 's/[[:space:]]*$//')"
  log "Updating kernel cmdline for systemd initramfs"
  echo "$NEW_CMDLINE" | sudo tee "$CMDLINE" >/dev/null
else
  log "Kernel cmdline already correct"
fi

# --- Ensure crypttab.initramfs entry ---
CRYPTTAB="/etc/crypttab.initramfs"
ENTRY="$MAPPER_NAME UUID=$LUKS_UUID none tpm2-device=auto"

sudo touch "$CRYPTTAB"

EXISTING_ENTRY="$(awk -v name="$MAPPER_NAME" '$1==name {print; exit}' "$CRYPTTAB")"
if [ -n "$EXISTING_ENTRY" ]; then
  if [ "$EXISTING_ENTRY" = "$ENTRY" ]; then
    log "crypttab entry already correct"
  else
    log "Updating crypttab entry"
    sudo awk -v name="$MAPPER_NAME" '$1!=name {print}' "$CRYPTTAB" | sudo tee "$CRYPTTAB" >/dev/null
    echo "$ENTRY" | sudo tee -a "$CRYPTTAB" >/dev/null
  fi
else
  log "Adding crypttab entry"
  echo "$ENTRY" | sudo tee -a "$CRYPTTAB" >/dev/null
fi

# --- Create and store recovery key (idempotent) ---
RECOVERY_FILE="/root/luks-recovery-key.txt"

# --- Prompt once for password if enrollment needed ---
LUKS_PASSWORD=""
TEMP_KEYFILE=""

if [ "$HAVE_RECOVERY" != "true" ] || [ "$HAVE_TPM2" != "true" ]; then
  log "LUKS enrollment required. You will be prompted for your disk encryption password."

  read -rs -p "Enter LUKS password: " LUKS_PASSWORD </dev/tty
  echo

  if [ -z "$LUKS_PASSWORD" ]; then
    die "Password cannot be empty"
  fi

  # Create temporary keyfile
  TEMP_KEYFILE="$(mktemp -t luks-key.XXXXXX)"
  chmod 600 "$TEMP_KEYFILE"
  echo -n "$LUKS_PASSWORD" > "$TEMP_KEYFILE"
fi

# --- Create recovery key ---
if [ "$HAVE_RECOVERY" != "true" ]; then
  log "Creating LUKS recovery key"

  if ! sudo systemd-cryptenroll "$LUKS_DEV" --unlock-key-file="$TEMP_KEYFILE" --recovery-key | sudo tee "$RECOVERY_FILE" >/dev/null; then
    die "Failed to enroll recovery key"
  fi

  log "Recovery key saved to $RECOVERY_FILE"
  sudo chmod 600 "$RECOVERY_FILE"
fi

# --- Enroll TPM2 ---
if [ "$HAVE_TPM2" != "true" ]; then
  log "Enrolling TPM2 auto-unlock"

  if ! sudo systemd-cryptenroll "$LUKS_DEV" --unlock-key-file="$TEMP_KEYFILE" --tpm2-device=auto; then
    die "Failed to enroll TPM2"
  fi
fi

# --- Final rebuild ---
log "Updating bootloader and initramfs"
sudo limine-update

log "FDE auto-unlock setup complete"
log "Recovery key is stored in $RECOVERY_FILE (keep this safe!)"
