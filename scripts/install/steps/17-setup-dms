#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/common"

log "Installing DankMaterialShell and dependencies..."
install_package niri xwayland-satellite xdg-desktop-portal-gnome xdg-desktop-portal-gtk matugen cava qt6-multimedia-ffmpeg
install_aur_package dms-shell-bin

TARGET_USER="${SUDO_USER:-${USER:-}}"
if [[ -z "$TARGET_USER" ]]; then
  die "Unable to determine target user for DMS greeter setup."
fi

log "Ensuring greeter group access for $TARGET_USER..."
run_sudo groupadd -f greeter
run_sudo usermod -aG greeter "$TARGET_USER"

log "Starting DMS..."
systemctl --user add-wants niri.service dms
dms greeter enable
dms greeter sync

log "DMS setup complete."
