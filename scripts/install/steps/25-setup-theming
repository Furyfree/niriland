#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/common"

log "Setting up theming and wallpapers..."

set_gsetting() {
  local schema="$1"
  local key="$2"
  local value="$3"

  if ! command -v gsettings >/dev/null 2>&1; then
    warn "gsettings not found, skipping desktop interface settings."
    return 1
  fi

  if ! gsettings set "$schema" "$key" "$value" >/dev/null 2>&1; then
    warn "Failed to set gsettings $schema $key"
    return 1
  fi

  return 0
}

# Interface style
set_gsetting "org.gnome.desktop.interface" "color-scheme" "prefer-dark" || true
set_gsetting "org.gnome.desktop.interface" "gtk-theme" "Graphite-Dark" || true
set_gsetting "org.gnome.desktop.interface" "icon-theme" "Papirus-Dark" || true
set_gsetting "org.gnome.desktop.interface" "cursor-theme" "macOS" || true
set_gsetting "org.gnome.desktop.interface" "cursor-size" "24" || true

# Fonts
set_gsetting "org.gnome.desktop.interface" "font-name" "SF Pro Text 11" || true
set_gsetting "org.gnome.desktop.interface" "document-font-name" "SF Pro Text 11" || true
set_gsetting "org.gnome.desktop.interface" "monospace-font-name" "JetBrainsMono Nerd Font 10" || true

BACKGROUNDS_SRC="$REPO_ROOT/configs/backgrounds"
PICTURES_DIR="$HOME/Pictures"
BACKGROUNDS_DST="$PICTURES_DIR/Wallpapers"
mkdir -p "$BACKGROUNDS_DST"

copied_count=0

if [[ -d "$BACKGROUNDS_SRC" ]]; then
  while IFS= read -r src_file; do
    rel_path="${src_file#$BACKGROUNDS_SRC/}"
    dest_file="$BACKGROUNDS_DST/$rel_path"

    mkdir -p "$(dirname "$dest_file")"

    if [[ -f "$dest_file" ]] && cmp -s "$src_file" "$dest_file"; then
      continue
    fi

    cp -a "$src_file" "$dest_file"
    copied_count=$((copied_count + 1))
  done < <(find "$BACKGROUNDS_SRC" -type f ! -name 'PLACEHOLDER' ! -name '.gitkeep' | sort)

  log "Wallpaper source: $BACKGROUNDS_SRC"
  log "Wallpaper destination: $BACKGROUNDS_DST"
  log "Wallpaper files updated: $copied_count"
else
  warn "Backgrounds directory not found at $BACKGROUNDS_SRC"
fi

mapfile -d '' -t wallpaper_files < <(find "$BACKGROUNDS_DST" -type f \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' -o -iname '*.bmp' -o -iname '*.gif' -o -iname '*.webp' \) -print0)

if [[ "${#wallpaper_files[@]}" -eq 0 ]]; then
  warn "No wallpapers found in $BACKGROUNDS_DST, skipping random wallpaper selection."
elif ! command -v dms >/dev/null 2>&1; then
  warn "dms command not found, skipping wallpaper setup."
else
  random_index=$((RANDOM % ${#wallpaper_files[@]}))
  selected_wallpaper="${wallpaper_files[$random_index]}"
  wallpaper_arg="$selected_wallpaper"

  if [[ "$selected_wallpaper" == "$HOME/"* ]]; then
    wallpaper_arg="${selected_wallpaper#"$HOME/"}"
  fi

  if dms ipc call wallpaper set "$wallpaper_arg" >/dev/null 2>&1; then
    log "Random wallpaper set: $wallpaper_arg"
  else
    warn "Failed to set wallpaper via dms ipc (is DMS running in this user session?)."
  fi
fi

log_success "Theming setup complete."
