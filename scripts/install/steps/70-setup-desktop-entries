#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/common"

APPLICATIONS_SRC="$REPO_ROOT/configs/base/.local/share/applications"
APPLICATIONS_DST="$HOME/.local/share/applications"
ICONS_SRC="$REPO_ROOT/configs/base/.local/share/icons"
HICOLOR_SRC="/usr/share/icons/hicolor/index.theme"
HICOLOR_DST="$HOME/.local/share/icons/hicolor"
HICOLOR_APPS_DST="$HICOLOR_DST/256x256/apps"
DESKTOP_ENTRIES_CHANGED=false
LAST_COPY_CHANGED=false

copy_if_changed() {
  local src_path="$1"
  local dest_path="$2"
  local label="$3"
  LAST_COPY_CHANGED=false

  mkdir -p "$(dirname "$dest_path")"

  if [[ -f "$src_path" && -f "$dest_path" ]] && cmp -s "$src_path" "$dest_path"; then
    log "$label unchanged, skipping."
    return 0
  fi

  if [[ -L "$src_path" && -L "$dest_path" ]] && [[ "$(readlink "$src_path")" == "$(readlink "$dest_path")" ]]; then
    log "$label unchanged, skipping."
    return 0
  fi

  cp -a "$src_path" "$dest_path"
  LAST_COPY_CHANGED=true
  log "Deployed $label"
}

deploy_spotlight_entries() {
  if [[ ! -d "$APPLICATIONS_SRC" ]]; then
    warn "Applications source directory not found: $APPLICATIONS_SRC"
    return 0
  fi

  mkdir -p "$APPLICATIONS_DST"

  while IFS= read -r src_path; do
    local rel_path="${src_path#$APPLICATIONS_SRC/}"
    copy_if_changed "$src_path" "$APPLICATIONS_DST/$rel_path" "applications/$rel_path"
    if [[ "$LAST_COPY_CHANGED" == "true" ]]; then
      DESKTOP_ENTRIES_CHANGED=true
    fi
  done < <(find "$APPLICATIONS_SRC" -mindepth 1 -maxdepth 1 \( -type f -o -type l \) | sort)
}

deploy_hidden_overrides() {
  local hidden_src="$APPLICATIONS_SRC/hidden"

  if [[ ! -d "$hidden_src" ]]; then
    warn "Hidden desktop entries directory not found: $hidden_src"
    return 0
  fi

  mkdir -p "$APPLICATIONS_DST"

  while IFS= read -r src_path; do
    local rel_path="${src_path#$hidden_src/}"
    local dest_path="$APPLICATIONS_DST/$rel_path"
    copy_if_changed "$src_path" "$dest_path" "applications/$rel_path hidden override"
    if [[ "$LAST_COPY_CHANGED" == "true" ]]; then
      DESKTOP_ENTRIES_CHANGED=true
    fi
  done < <(find "$hidden_src" \( -type f -o -type l \) | sort)
}

restart_dms_if_needed() {
  if [[ "$DESKTOP_ENTRIES_CHANGED" != "true" ]]; then
    log "No desktop entry changes detected, skipping DMS restart."
    return 0
  fi

  if ! command -v systemctl >/dev/null 2>&1; then
    warn "systemctl not found, skipping DMS restart."
    return 0
  fi

  log "Desktop entries changed, restarting DMS."
  if systemctl --user restart dms >/dev/null 2>&1; then
    log "DMS restarted."
  else
    warn "Failed to restart dms user service (no active user session?)."
  fi
}

deploy_hicolor_theme() {
  if [[ ! -d "$ICONS_SRC" ]]; then
    warn "Icons source directory not found: $ICONS_SRC"
    return 0
  fi

  mkdir -p "$HICOLOR_APPS_DST"

  if [[ -f "$HICOLOR_SRC" ]]; then
    copy_if_changed "$HICOLOR_SRC" "$HICOLOR_DST/index.theme" "icons/hicolor/index.theme"
  else
    warn "System hicolor index.theme not found: $HICOLOR_SRC"
  fi

  while IFS= read -r src_path; do
    local file_name
    file_name="$(basename "$src_path")"
    copy_if_changed "$src_path" "$HICOLOR_APPS_DST/$file_name" "icons/hicolor/256x256/apps/$file_name"
  done < <(find "$ICONS_SRC" -mindepth 1 -maxdepth 1 \( -type f -o -type l \) | sort)
}

refresh_icon_cache() {
  if command -v gtk-update-icon-cache >/dev/null 2>&1; then
    log "Refreshing icon cache"
    gtk-update-icon-cache -f -t "$HICOLOR_DST"
  else
    warn "gtk-update-icon-cache not found, skipping icon cache refresh."
  fi
}

log "Deploying desktop entries for DMS spotlight"
deploy_spotlight_entries
log "Applying hidden desktop entry overrides"
deploy_hidden_overrides
restart_dms_if_needed

log "Deploying hicolor icon theme entries"
deploy_hicolor_theme
refresh_icon_cache

log_success "Desktop entries setup complete."
