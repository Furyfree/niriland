#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/common"

log "Running post-install tasks"

if command -v fc-cache >/dev/null 2>&1; then
  log "Refreshing font cache"
  fc-cache -fv >/dev/null
else
  warn "fc-cache not found, skipping font cache refresh."
fi

if [[ -d "$HOME/.local/share/applications" ]]; then
  if command -v update-desktop-database >/dev/null 2>&1; then
    log "Refreshing desktop entry database"
    run_sudo update-desktop-database "$HOME/.local/share/applications" >/dev/null
  else
    warn "update-desktop-database not found, skipping desktop database refresh."
  fi
fi

if [[ -f "$HOME/.local/share/icons/hicolor/index.theme" ]]; then
  if command -v gtk-update-icon-cache >/dev/null 2>&1; then
    log "Refreshing icon cache"
    gtk-update-icon-cache -f -t "$HOME/.local/share/icons/hicolor"
  else
    warn "gtk-update-icon-cache not found, skipping icon cache refresh."
  fi
fi

log_success "Post-install tasks complete."
warn "Log out or reboot to ensure shell, group, and PAM changes are fully applied."
warn "Run niriland-setup-fingerprint to setup fingerprint"
