#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/common"

log "Running post-install tasks"

require_cmd fc-cache
log "Refreshing font cache"
fc-cache -fv >/dev/null

if [[ -d "$HOME/.local/share/applications" ]]; then
  require_cmd update-desktop-database
  log "Refreshing desktop entry database"
  update-desktop-database "$HOME/.local/share/applications" >/dev/null
fi

if [[ -f "$HOME/.local/share/icons/hicolor/index.theme" ]]; then
  require_cmd gtk-update-icon-cache
  log "Refreshing icon cache"
  gtk-update-icon-cache -f -t "$HOME/.local/share/icons/hicolor"
fi

require_cmd dms
log "Restarting DMS user service"
if dms restart >/dev/null 2>&1; then
  log "DMS restarted."
else
  warn "Failed to restart dms user service (no active user session?)."
fi

require_cmd limine-snapper-sync
log "Syncing limine-snapper"
run_sudo limine-snapper-sync

log_success "Post-install tasks complete."
warn "Log out or reboot to ensure shell, group, and PAM changes are fully applied."
warn "Run niriland-setup-fingerprint to setup fingerprint"
