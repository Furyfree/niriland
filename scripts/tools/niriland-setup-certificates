#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPT_REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

CERT_NAME="Eduroam_aug2020.pem"

if [[ -f "$SCRIPT_REPO_ROOT/configs/system/etc/certs/$CERT_NAME" ]]; then
  REPO_ROOT="$SCRIPT_REPO_ROOT"
elif [[ -f "$PWD/configs/system/etc/certs/$CERT_NAME" ]]; then
  REPO_ROOT="$PWD"
else
  REPO_ROOT="${NIRILAND_DIR:-$HOME/.local/share/niriland}"
fi

CERT_SRC="$REPO_ROOT/configs/system/etc/certs/$CERT_NAME"
CERT_DIR="/etc/certs"
CERT_DST="$CERT_DIR/$CERT_NAME"

log() {
  printf '==> %s\n' "$*"
}

warn() {
  printf 'WARN: %s\n' "$*" >&2
}

die() {
  printf 'ERROR: %s\n' "$*" >&2
  exit 1
}

usage() {
  cat <<'EOF'
Usage: niriland-setup-certificates [setup|status|help]

Commands:
  setup   Install DTU Eduroam certificate and refresh CA trust (default)
  status  Show installed certificate status
  help    Show this help

Environment:
  NIRILAND_DIR  Fallback path to the niriland repo
EOF
}

require_cmd() {
  command -v "$1" >/dev/null 2>&1 || die "Missing required command: $1"
}

require_sudo() {
  sudo -v || die "sudo authentication failed"
}

setup_certificates() {
  require_cmd sudo
  require_cmd update-ca-trust
  require_sudo

  [[ -f "$CERT_SRC" ]] || die "Certificate not found: $CERT_SRC"

  log "Using repo: $REPO_ROOT"
  sudo install -d "$CERT_DIR"

  if [[ -f "$CERT_DST" ]] && cmp -s "$CERT_SRC" "$CERT_DST"; then
    log "Certificate already up to date: $CERT_DST"
  else
    log "Installing DTU Eduroam certificate"
    sudo install -m 0644 "$CERT_SRC" "$CERT_DST"
  fi

  log "Updating system CA trust"
  sudo update-ca-trust
  log "Certificate setup complete."
}

show_status() {
  if [[ -f "$CERT_DST" ]]; then
    log "Installed certificate found: $CERT_DST"
  else
    warn "Installed certificate missing: $CERT_DST"
  fi

  if [[ ! -f "$CERT_SRC" ]]; then
    warn "Source certificate not found in repo: $CERT_SRC"
    return 0
  fi

  if [[ -f "$CERT_DST" ]] && cmp -s "$CERT_SRC" "$CERT_DST"; then
    log "Installed certificate matches repo copy."
  elif [[ -f "$CERT_DST" ]]; then
    warn "Installed certificate differs from repo copy."
  fi
}

case "${1:-setup}" in
  setup)
    setup_certificates
    ;;
  status)
    show_status
    ;;
  help|--help|-h)
    usage
    ;;
  *)
    usage
    exit 1
    ;;
esac
